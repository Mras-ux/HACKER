<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HACKER交流会公开赛审核系统</title>
    <!-- 引入 Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --gray-color: #95a5a6;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--dark-color);
            color: white;
            padding: 20px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: var(--light-color);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            transition: all 0.3s;
        }
        
        .tab.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .tab:hover:not(.active) {
            background-color: #ddd;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            background-color: white;
            border-radius: 0 5px 5px 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input[type="text"],
        input[type="email"],
        input[type="datetime-local"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
        }
        
        .btn-secondary:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .problem-container {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        
        .problem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .problem-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .admin-panel {
            background-color: var(--dark-color);
            color: white;
            padding: 20px;
            border-radius: 5px;
            margin-top: 30px;
            display: none;
        }
        
        .admin-panel h2 {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .admin-tabs {
            display: flex;
            margin-bottom: 20px;
        }
        
        .admin-tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #34495e;
            border: none;
            color: white;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        
        .admin-tab.active {
            background-color: var(--primary-color);
        }
        
        .request-list {
            background-color: white;
            border-radius: 5px;
            padding: 15px;
            color: #333;
        }
        
        .request-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .request-info {
            flex: 1;
        }
        
        .request-actions {
            display: flex;
            gap: 10px;
        }
        
        .request-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .request-email {
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .request-detail {
            margin-top: 20px;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            color: #333;
            display: none;
        }
        
        .back-btn {
            margin-bottom: 20px;
        }
        
        .result-item {
            background-color: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .result-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 14px;
            margin-left: 10px;
        }
        
        .status-pending {
            background-color: #f39c12;
            color: white;
        }
        
        .status-approved {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .status-rejected {
            background-color: var(--danger-color);
            color: white;
        }
        
        .clear-results {
            margin-top: 20px;
            text-align: right;
        }
        
        /* 隐藏管理员入口样式 */
        .admin-access {
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background-color: transparent;
            border: none;
            cursor: pointer;
            z-index: 1000;
            opacity: 0.01;
        }
        
        .secret-admin-login {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            z-index: 1001;
            display: none;
        }
        
        .secret-admin-login input {
            display: block;
            margin: 10px 0;
            padding: 8px;
            width: 200px;
        }
        
        .secret-admin-login button {
            padding: 8px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: var(--gray-color);
        }
        
        .error-message {
            color: var(--danger-color);
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>HACKER交流会公开赛审核系统</h1>
            <p class="subtitle">公平 · 公正 · 公开</p>
        </header>
        
        <div class="tabs">
            <div class="tab active" onclick="openTab(event, 'submit-contest')">提交比赛申请</div>
            <div class="tab" onclick="openTab(event, 'submit-problem')">提交单题申请</div>
            <div class="tab" onclick="openTab(event, 'query-result')">查询结果</div>
        </div>
        
        <div id="submit-contest" class="tab-content active">
            <h2>比赛申请</h2>
            <form id="contest-form">
                <div class="form-group">
                    <h3>负责人信息</h3>
                    <label for="contest-oj">OJ名字</label>
                    <input type="text" id="contest-oj" required>
                    
                    <label for="contest-uid">UID</label>
                    <input type="text" id="contest-uid" required>
                    
                    <label for="contest-email">邮箱</label>
                    <input type="email" id="contest-email" required>
                    
                    <label for="contest-awards">获奖经历</label>
                    <textarea id="contest-awards" required></textarea>
                </div>
                
                <div class="form-group">
                    <h3>比赛信息</h3>
                    <label for="contest-name">比赛昵称</label>
                    <input type="text" id="contest-name" required>
                    
                    <label for="contest-info">比赛信息</label>
                    <textarea id="contest-info" required></textarea>
                    
                    <label for="contest-start">开始时间</label>
                    <input type="datetime-local" id="contest-start" required>
                    
                    <label for="contest-end">结束时间</label>
                    <input type="datetime-local" id="contest-end" required>
                </div>
                
                <div class="form-group">
                    <h3>题目信息</h3>
                    <label for="contest-problem-count">题目数量</label>
                    <input type="number" id="contest-problem-count" min="1" value="1" required onchange="updateProblemInputs()">
                    
                    <div id="contest-problems-container">
                        <!-- 动态生成的题目输入框会放在这里 -->
                    </div>
                </div>
                
                <button type="submit" class="btn">提交申请</button>
                <div id="contest-form-error" class="error-message"></div>
            </form>
        </div>
        
        <div id="submit-problem" class="tab-content">
            <h2>单题申请</h2>
            <form id="problem-form">
                <div class="form-group">
                    <h3>负责人信息</h3>
                    <label for="problem-oj">OJ名字</label>
                    <input type="text" id="problem-oj" required>
                    
                    <label for="problem-uid">UID</label>
                    <input type="text" id="problem-uid" required>
                    
                    <label for="problem-email">邮箱</label>
                    <input type="email" id="problem-email" required>
                    
                    <label for="problem-awards">获奖经历</label>
                    <textarea id="problem-awards" required></textarea>
                </div>
                
                <div class="form-group">
                    <h3>题目信息</h3>
                    <label for="problem-title">题目标题</label>
                    <input type="text" id="problem-title" required>
                    
                    <label for="problem-author">出题人</label>
                    <input type="text" id="problem-author" required>
                    
                    <label for="problem-difficulty">难度</label>
                    <select id="problem-difficulty" required>
                        <option value="入门">入门</option>
                        <option value="普及">普及</option>
                        <option value="普及/提高-">普及/提高-</option>
                        <option value="普及+/提高">普及+/提高</option>
                        <option value="提高+/省选-">提高+/省选-</option>
                        <option value="省选/NOI-">省选/NOI-</option>
                        <option value="NOI/NOI+/CTSC">NOI/NOI+/CTSC</option>
                    </select>
                    
                    <label for="problem-description">题目描述</label>
                    <textarea id="problem-description" required></textarea>
                    
                    <label for="problem-data">数据包 (请上传zip文件)</label>
                    <input type="file" id="problem-data" accept=".zip" required>
                </div>
                
                <button type="submit" class="btn">提交申请</button>
                <div id="problem-form-error" class="error-message"></div>
            </form>
        </div>
        
        <div id="query-result" class="tab-content">
            <h2>查询结果</h2>
            <div class="form-group">
                <label for="query-email">请输入您的邮箱</label>
                <input type="email" id="query-email" required>
                <button class="btn" onclick="queryResults()">查询</button>
            </div>
            
            <div id="results-container">
                <!-- 查询结果会显示在这里 -->
            </div>
            
            <div class="clear-results">
                <button class="btn btn-danger" onclick="clearResults()">清除查询结果</button>
            </div>
        </div>
        
        <div id="admin-panel" class="admin-panel">
            <h2>管理员后台</h2>
            
            <div class="admin-tabs">
                <div class="admin-tab active" onclick="openAdminTab(event, 'admin-contests')">比赛申请 (<span id="contest-count">0</span>)</div>
                <div class="admin-tab" onclick="openAdminTab(event, 'admin-problems')">单题申请 (<span id="problem-count">0</span>)</div>
            </div>
            
            <div id="admin-contests" class="request-list">
                <div id="contest-requests-container">
                    <p class="loading">加载中...</p>
                </div>
            </div>
            
            <div id="admin-problems" class="request-list" style="display: none;">
                <div id="problem-requests-container">
                    <p class="loading">加载中...</p>
                </div>
            </div>
            
            <div id="admin-detail" class="request-detail">
                <button class="btn back-btn" onclick="backToList()">返回列表</button>
                <div id="detail-content">
                    <!-- 详情内容会显示在这里 -->
                </div>
                <div class="request-actions">
                    <button class="btn btn-secondary" onclick="approveRequest()">通过</button>
                    <button class="btn btn-danger" onclick="rejectRequest()">拒绝</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 隐藏的管理员入口 -->
    <button class="admin-access" onclick="showSecretAdminLogin()"></button>
    
    <!-- 秘密管理员登录框 -->
    <div id="secret-admin-login" class="secret-admin-login">
        <h3>管理员登录</h3>
        <input type="password" id="secret-admin-password" placeholder="请输入管理员密码">
        <button onclick="secretAdminLogin()">登录</button>
        <button onclick="hideSecretAdminLogin()">取消</button>
    </div>

    <script>
        // Firebase配置 - 替换为你自己的配置
        const firebaseConfig = {
            apiKey: "AIzaSyABC123XYZ456DEF789GHI012JKL345MNO",
            authDomain: "your-project-id.firebaseapp.com",
            databaseURL: "https://your-project-id.firebaseio.com",
            projectId: "your-project-id",
            storageBucket: "your-project-id.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abc123def456ghi789jkl"
        };

        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // 存储数据
        let contestRequests = [];
        let problemRequests = [];
        let results = [];
        let currentDetailId = null;
        let currentDetailType = null;
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 从Firebase加载数据
            loadAllDataFromFirebase();
            updateProblemInputs();
            
            // 表单提交事件
            document.getElementById('contest-form').addEventListener('submit', function(e) {
                e.preventDefault();
                submitContest();
            });
            
            document.getElementById('problem-form').addEventListener('submit', function(e) {
                e.preventDefault();
                submitProblem();
            });
        });

        // 从Firebase加载所有数据
        function loadAllDataFromFirebase() {
            // 监听比赛申请变化
            database.ref('contestRequests').orderByChild('status').equalTo('pending').on('value', (snapshot) => {
                contestRequests = [];
                snapshot.forEach((childSnapshot) => {
                    const request = childSnapshot.val();
                    request.id = childSnapshot.key;
                    contestRequests.push(request);
                });
                updateRequestCounts();
                if (document.getElementById('admin-panel').style.display === 'block' && 
                    document.getElementById('admin-contests').style.display === 'block') {
                    displayContestRequests();
                }
            });

            // 监听单题申请变化
            database.ref('problemRequests').orderByChild('status').equalTo('pending').on('value', (snapshot) => {
                problemRequests = [];
                snapshot.forEach((childSnapshot) => {
                    const request = childSnapshot.val();
                    request.id = childSnapshot.key;
                    problemRequests.push(request);
                });
                updateRequestCounts();
                if (document.getElementById('admin-panel').style.display === 'block' && 
                    document.getElementById('admin-problems').style.display === 'block') {
                    displayProblemRequests();
                }
            });

            // 监听结果变化
            database.ref('results').on('value', (snapshot) => {
                results = [];
                snapshot.forEach((childSnapshot) => {
                    const result = childSnapshot.val();
                    result.id = childSnapshot.key;
                    results.push(result);
                });
            });
        }

        // 更新比赛题目输入框
        function updateProblemInputs() {
            const count = parseInt(document.getElementById('contest-problem-count').value);
            const container = document.getElementById('contest-problems-container');
            container.innerHTML = '';
            
            for (let i = 1; i <= count; i++) {
                const problemDiv = document.createElement('div');
                problemDiv.className = 'problem-container';
                problemDiv.innerHTML = `
                    <div class="problem-header">
                        <div class="problem-title">题目 ${i}</div>
                    </div>
                    <div class="form-group">
                        <label for="contest-problem-title-${i}">题目标题</label>
                        <input type="text" id="contest-problem-title-${i}" required>
                    </div>
                    <div class="form-group">
                        <label for="contest-problem-author-${i}">出题人</label>
                        <input type="text" id="contest-problem-author-${i}" required>
                    </div>
                    <div class="form-group">
                        <label for="contest-problem-difficulty-${i}">难度</label>
                        <select id="contest-problem-difficulty-${i}" required>
                            <option value="入门">入门</option>
                            <option value="普及">普及</option>
                            <option value="普及/提高-">普及/提高-</option>
                            <option value="普及+/提高">普及+/提高</option>
                            <option value="提高+/省选-">提高+/省选-</option>
                            <option value="省选/NOI-">省选/NOI-</option>
                            <option value="NOI/NOI+/CTSC">NOI/NOI+/CTSC</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="contest-problem-description-${i}">题目描述</label>
                        <textarea id="contest-problem-description-${i}" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="contest-problem-data-${i}">数据包 (请上传zip文件)</label>
                        <input type="file" id="contest-problem-data-${i}" accept=".zip" required>
                    </div>
                `;
                container.appendChild(problemDiv);
            }
        }
        
        // 提交比赛申请
        function submitContest() {
            const errorElement = document.getElementById('contest-form-error');
            errorElement.textContent = '';
            
            const oj = document.getElementById('contest-oj').value;
            const uid = document.getElementById('contest-uid').value;
            const email = document.getElementById('contest-email').value;
            const awards = document.getElementById('contest-awards').value;
            const name = document.getElementById('contest-name').value;
            const info = document.getElementById('contest-info').value;
            const start = document.getElementById('contest-start').value;
            const end = document.getElementById('contest-end').value;
            const count = parseInt(document.getElementById('contest-problem-count').value);
            
            // 验证数据
            if (!oj || !uid || !email || !awards || !name || !info || !start || !end || count < 1) {
                errorElement.textContent = '请填写所有必填字段';
                return;
            }
            
            const problems = [];
            for (let i = 1; i <= count; i++) {
                const title = document.getElementById(`contest-problem-title-${i}`).value;
                const author = document.getElementById(`contest-problem-author-${i}`).value;
                const difficulty = document.getElementById(`contest-problem-difficulty-${i}`).value;
                const description = document.getElementById(`contest-problem-description-${i}`).value;
                const data = document.getElementById(`contest-problem-data-${i}`).files[0]?.name || '未上传';
                
                if (!title || !author || !difficulty || !description) {
                    errorElement.textContent = `请填写题目 ${i} 的所有信息`;
                    return;
                }
                
                problems.push({
                    title,
                    author,
                    difficulty,
                    description,
                    data
                });
            }
            
            const request = {
                type: 'contest',
                oj,
                uid,
                email,
                awards,
                name,
                info,
                start,
                end,
                problems,
                status: 'pending',
                timestamp: new Date().toISOString()
            };
            
            // 显示加载状态
            const submitBtn = document.querySelector('#contest-form button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = '提交中...';
            
            // 保存到Firebase
            const newRequestRef = database.ref('contestRequests').push();
            newRequestRef.set(request)
                .then(() => {
                    // 添加到结果列表
                    const result = {
                        type: 'contest',
                        name: name,
                        email: email,
                        status: 'pending',
                        timestamp: request.timestamp,
                        requestId: newRequestRef.key
                    };
                    return database.ref('results').push(result);
                })
                .then(() => {
                    alert('比赛申请提交成功！');
                    document.getElementById('contest-form').reset();
                    updateProblemInputs();
                })
                .catch((error) => {
                    console.error('提交失败:', error);
                    errorElement.textContent = '提交失败，请重试';
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                });
        }

        // 提交单题申请
        function submitProblem() {
            const errorElement = document.getElementById('problem-form-error');
            errorElement.textContent = '';
            
            const oj = document.getElementById('problem-oj').value;
            const uid = document.getElementById('problem-uid').value;
            const email = document.getElementById('problem-email').value;
            const awards = document.getElementById('problem-awards').value;
            const title = document.getElementById('problem-title').value;
            const author = document.getElementById('problem-author').value;
            const difficulty = document.getElementById('problem-difficulty').value;
            const description = document.getElementById('problem-description').value;
            const data = document.getElementById('problem-data').files[0]?.name || '未上传';
            
            // 验证数据
            if (!oj || !uid || !email || !awards || !title || !author || !difficulty || !description) {
                errorElement.textContent = '请填写所有必填字段';
                return;
            }
            
            const request = {
                type: 'problem',
                oj,
                uid,
                email,
                awards,
                title,
                author,
                difficulty,
                description,
                data,
                status: 'pending',
                timestamp: new Date().toISOString()
            };
            
            // 显示加载状态
            const submitBtn = document.querySelector('#problem-form button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = '提交中...';
            
            // 保存到Firebase
            const newRequestRef = database.ref('problemRequests').push();
            newRequestRef.set(request)
                .then(() => {
                    // 添加到结果列表
                    const result = {
                        type: 'problem',
                        name: title,
                        email: email,
                        status: 'pending',
                        timestamp: request.timestamp,
                        requestId: newRequestRef.key
                    };
                    return database.ref('results').push(result);
                })
                .then(() => {
                    alert('单题申请提交成功！');
                    document.getElementById('problem-form').reset();
                })
                .catch((error) => {
                    console.error('提交失败:', error);
                    errorElement.textContent = '提交失败，请重试';
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                });
        }

        // 更新申请数量显示
        function updateRequestCounts() {
            document.getElementById('contest-count').textContent = contestRequests.length;
            document.getElementById('problem-count').textContent = problemRequests.length;
        }
        
        // 显示秘密管理员登录框
        function showSecretAdminLogin() {
            document.getElementById('secret-admin-login').style.display = 'block';
        }
        
        // 隐藏秘密管理员登录框
        function hideSecretAdminLogin() {
            document.getElementById('secret-admin-login').style.display = 'none';
            document.getElementById('secret-admin-password').value = '';
        }
        
        // 秘密管理员登录
        function secretAdminLogin() {
            const password = document.getElementById('secret-admin-password').value;
            if (password === 'admin123') {
                document.getElementById('admin-panel').style.display = 'block';
                hideSecretAdminLogin();
                displayContestRequests();
            } else {
                alert('密码错误！');
            }
        }
        
        // 切换管理员标签页
        function openAdminTab(evt, tabName) {
            const tabContents = document.querySelectorAll('.request-list');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].style.display = 'none';
            }
            
            const tabs = document.querySelectorAll('.admin-tab');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            document.getElementById(tabName).style.display = 'block';
            evt.currentTarget.classList.add('active');
            
            if (tabName === 'admin-contests') {
                displayContestRequests();
            } else if (tabName === 'admin-problems') {
                displayProblemRequests();
            }
        }
        
        // 显示比赛申请列表
        function displayContestRequests() {
            const container = document.getElementById('contest-requests-container');
            
            if (contestRequests.length === 0) {
                container.innerHTML = '<p>暂无比赛申请</p>';
                return;
            }
            
            container.innerHTML = '';
            
            contestRequests.forEach(request => {
                const requestItem = document.createElement('div');
                requestItem.className = 'request-item';
                requestItem.innerHTML = `
                    <div class="request-info">
                        <div class="request-title">${request.name}</div>
                        <div class="request-email">${request.email}</div>
                        <div>开始时间: ${formatDateTime(request.start)} - 结束时间: ${formatDateTime(request.end)}</div>
                        <div>题目数量: ${request.problems.length}</div>
                    </div>
                    <div class="request-actions">
                        <button class="btn" onclick="viewRequestDetail('${request.id}', 'contest')">查看</button>
                    </div>
                `;
                container.appendChild(requestItem);
            });
        }
        
        // 显示单题申请列表
        function displayProblemRequests() {
            const container = document.getElementById('problem-requests-container');
            
            if (problemRequests.length === 0) {
                container.innerHTML = '<p>暂无单题申请</p>';
                return;
            }
            
            container.innerHTML = '';
            
            problemRequests.forEach(request => {
                const requestItem = document.createElement('div');
                requestItem.className = 'request-item';
                requestItem.innerHTML = `
                    <div class="request-info">
                        <div class="request-title">${request.title}</div>
                        <div class="request-email">${request.email}</div>
                        <div>难度: ${request.difficulty}</div>
                        <div>出题人: ${request.author}</div>
                    </div>
                    <div class="request-actions">
                        <button class="btn" onclick="viewRequestDetail('${request.id}', 'problem')">查看</button>
                    </div>
                `;
                container.appendChild(requestItem);
            });
        }
        
        // 查看申请详情
        function viewRequestDetail(id, type) {
            currentDetailId = id;
            currentDetailType = type;
            
            document.querySelector('.request-list').style.display = 'none';
            document.getElementById('admin-detail').style.display = 'block';
            
            const detailContent = document.getElementById('detail-content');
            detailContent.innerHTML = '<p class="loading">加载中...</p>';
            
            const ref = type === 'contest' ? 
                database.ref('contestRequests/' + id) : 
                database.ref('problemRequests/' + id);
            
            ref.once('value').then((snapshot) => {
                const request = snapshot.val();
                if (!request) {
                    detailContent.innerHTML = '<p>申请不存在或已被处理</p>';
                    return;
                }
                
                if (type === 'contest') {
                    let problemsHtml = '';
                    request.problems.forEach((problem, index) => {
                        problemsHtml += `
                            <div class="problem-container">
                                <div class="problem-header">
                                    <div class="problem-title">题目 ${index + 1}</div>
                                </div>
                                <div class="form-group">
                                    <label>题目标题</label>
                                    <p>${problem.title}</p>
                                </div>
                                <div class="form-group">
                                    <label>出题人</label>
                                    <p>${problem.author}</p>
                                </div>
                                <div class="form-group">
                                    <label>难度</label>
                                    <p>${problem.difficulty}</p>
                                </div>
                                <div class="form-group">
                                    <label>题目描述</label>
                                    <pre>${problem.description}</pre>
                                </div>
                                <div class="form-group">
                                    <label>数据包</label>
                                    <p>${problem.data}</p>
                                </div>
                            </div>
                        `;
                    });
                    
                    detailContent.innerHTML = `
                        <h3>负责人信息</h3>
                        <div class="form-group">
                            <label>OJ名字</label>
                            <p>${request.oj}</p>
                        </div>
                        <div class="form-group">
                            <label>UID</label>
                            <p>${request.uid}</p>
                        </div>
                        <div class="form-group">
                            <label>邮箱</label>
                            <p>${request.email}</p>
                        </div>
                        <div class="form-group">
                            <label>获奖经历</label>
                            <pre>${request.awards}</pre>
                        </div>
                        
                        <h3>比赛信息</h3>
                        <div class="form-group">
                            <label>比赛昵称</label>
                            <p>${request.name}</p>
                        </div>
                        <div class="form-group">
                            <label>比赛信息</label>
                            <pre>${request.info}</pre>
                        </div>
                        <div class="form-group">
                            <label>开始时间</label>
                            <p>${formatDateTime(request.start)}</p>
                        </div>
                        <div class="form-group">
                            <label>结束时间</label>
                            <p>${formatDateTime(request.end)}</p>
                        </div>
                        
                        <h3>题目信息</h3>
                        <div class="form-group">
                            <label>题目数量</label>
                            <p>${request.problems.length}</p>
                        </div>
                        
                        ${problemsHtml}
                    `;
                } else if (type === 'problem') {
                    detailContent.innerHTML = `
                        <h3>负责人信息</h3>
                        <div class="form-group">
                            <label>OJ名字</label>
                            <p>${request.oj}</p>
                        </div>
                        <div class="form-group">
                            <label>UID</label>
                            <p>${request.uid}</p>
                        </div>
                        <div class="form-group">
                            <label>邮箱</label>
                            <p>${request.email}</p>
                        </div>
                        <div class="form-group">
                            <label>获奖经历</label>
                            <pre>${request.awards}</pre>
                        </div>
                        
                        <h3>题目信息</h3>
                        <div class="form-group">
                            <label>题目标题</label>
                            <p>${request.title}</p>
                        </div>
                        <div class="form-group">
                            <label>出题人</label>
                            <p>${request.author}</p>
                        </div>
                        <div class="form-group">
                            <label>难度</label>
                            <p>${request.difficulty}</p>
                        </div>
                        <div class="form-group">
                            <label>题目描述</label>
                            <pre>${request.description}</pre>
                        </div>
                        <div class="form-group">
                            <label>数据包</label>
                            <p>${request.data}</p>
                        </div>
                    `;
                }
            }).catch((error) => {
                console.error('加载详情失败:', error);
                detailContent.innerHTML = '<p class="error-message">加载详情失败，请重试</p>';
            });
        }
        
        // 返回列表
        function backToList() {
            document.getElementById('admin-detail').style.display = 'none';
            document.querySelector('.request-list[style="display: block;"]').style.display = 'block';
        }
        
        // 通过申请
        function approveRequest() {
            const ref = currentDetailType === 'contest' ? 
                database.ref('contestRequests/' + currentDetailId) : 
                database.ref('problemRequests/' + currentDetailId);
            
            const approveBtn = document.querySelector('#admin-detail .btn-secondary');
            const rejectBtn = document.querySelector('#admin-detail .btn-danger');
            const originalApproveText = approveBtn.textContent;
            const originalRejectText = rejectBtn.textContent;
            
            approveBtn.disabled = true;
            rejectBtn.disabled = true;
            approveBtn.textContent = '处理中...';
            
            ref.update({ status: 'approved' })
                .then(() => {
                    // 更新结果状态
                    return database.ref('results').orderByChild('requestId').equalTo(currentDetailId).once('value')
                        .then((snapshot) => {
                            const updates = {};
                            snapshot.forEach((childSnapshot) => {
                                updates['results/' + childSnapshot.key + '/status'] = 'approved';
                            });
                            return database.ref().update(updates);
                        });
                })
                .then(() => {
                    backToList();
                    alert('已通过申请');
                })
                .catch((error) => {
                    console.error('操作失败:', error);
                    alert('操作失败，请重试');
                })
                .finally(() => {
                    approveBtn.disabled = false;
                    rejectBtn.disabled = false;
                    approveBtn.textContent = originalApproveText;
                    rejectBtn.textContent = originalRejectText;
                });
        }

        // 拒绝申请
        function rejectRequest() {
            const ref = currentDetailType === 'contest' ? 
                database.ref('contestRequests/' + currentDetailId) : 
                database.ref('problemRequests/' + currentDetailId);
            
            const approveBtn = document.querySelector('#admin-detail .btn-secondary');
            const rejectBtn = document.querySelector('#admin-detail .btn-danger');
            const originalApproveText = approveBtn.textContent;
            const originalRejectText = rejectBtn.textContent;
            
            approveBtn.disabled = true;
            rejectBtn.disabled = true;
            rejectBtn.textContent = '处理中...';
            
            ref.update({ status: 'rejected' })
                .then(() => {
                    // 更新结果状态
                    return database.ref('results').orderByChild('requestId').equalTo(currentDetailId).once('value')
                        .then((snapshot) => {
                            const updates = {};
                            snapshot.forEach((childSnapshot) => {
                                updates['results/' + childSnapshot.key + '/status'] = 'rejected';
                            });
                            return database.ref().update(updates);
                        });
                })
                .then(() => {
                    backToList();
                    alert('已拒绝申请');
                })
                .catch((error) => {
                    console.error('操作失败:', error);
                    alert('操作失败，请重试');
                })
                .finally(() => {
                    approveBtn.disabled = false;
                    rejectBtn.disabled = false;
                    approveBtn.textContent = originalApproveText;
                    rejectBtn.textContent = originalRejectText;
                });
        }

        // 查询结果
        function queryResults() {
            const email = document.getElementById('query-email').value.trim();
            if (!email) {
                alert('请输入邮箱');
                return;
            }
            
            const container = document.getElementById('results-container');
            container.innerHTML = '<p class="loading">查询中...</p>';
            
            const queryBtn = document.querySelector('#query-result .btn');
            const originalText = queryBtn.textContent;
            queryBtn.disabled = true;
            queryBtn.textContent = '查询中...';
            
            database.ref('results').orderByChild('email').equalTo(email).once('value')
                .then((snapshot) => {
                    container.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        container.innerHTML = '<p>没有找到您的申请记录</p>';
                        return;
                    }
                    
                    let hasResults = false;
                    snapshot.forEach((childSnapshot) => {
                        const result = childSnapshot.val();
                        hasResults = true;
                        
                        const resultItem = document.createElement('div');
                        resultItem.className = 'result-item';
                        
                        let statusClass = 'status-pending';
                        if (result.status === 'approved') statusClass = 'status-approved';
                        else if (result.status === 'rejected') statusClass = 'status-rejected';
                        
                        resultItem.innerHTML = `
                            <h3>${result.type === 'contest' ? '比赛申请' : '单题申请'}: ${result.name}</h3>
                            <p>申请时间: ${formatDateTime(result.timestamp)}</p>
                            <p>状态: <span class="result-status ${statusClass}">${
                                result.status === 'pending' ? '审核中' : 
                                result.status === 'approved' ? '已通过' : '已拒绝'
                            }</span></p>
                        `;
                        container.appendChild(resultItem);
                    });
                    
                    if (!hasResults) {
                        container.innerHTML = '<p>没有找到您的申请记录</p>';
                    }
                })
                .catch((error) => {
                    console.error('查询失败:', error);
                    container.innerHTML = '<p class="error-message">查询失败，请重试</p>';
                })
                .finally(() => {
                    queryBtn.disabled = false;
                    queryBtn.textContent = originalText;
                });
        }
        
        // 清除查询结果
        function clearResults() {
            document.getElementById('results-container').innerHTML = '';
            document.getElementById('query-email').value = '';
        }
        
        // 格式化日期时间
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '';
            
            const date = new Date(dateTimeStr);
            if (isNaN(date.getTime())) return dateTimeStr;
            
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        // 切换标签页
        function openTab(evt, tabName) {
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            const tabs = document.getElementsByClassName('tab');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }
    </script>
</body>
</html>
